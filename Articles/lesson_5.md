## Коллекции

_Коллекцией_ называется структура данных, по своей функциональности сходная со списком или одномерным массивом. В сущности, коллекция — ближайший аналог традиционных массивов в программах PL/SQL. Эта глава поможет вам решить, какой из трех разных типов коллекций (ассоциативный массив, вложенная таблица, VARRAY) лучше всего соответствует потребностям вашей программы. Также вы познакомитесь с примерами определения этих структур и работы с ними.
Несколько типичных ситуаций для применения коллекций:
- Ведение списков данных в программах. Вероятно, это самое частое применение
коллекций в программах. Да, с таким же успехом можно воспользоваться реляционными таблицами, глобальными временными таблицами (работа с которыми потребует частых переключений контекста) или строками с разделителями, но коллекции чрезвычайно эффективны, а код работы с ними получается очень выразительным и простым в сопровождении.
- Ускорение многострочных операций SQL на порядок и более. Использование
коллекций в сочетании с конструкциями FORALL и BULK COLLECT радикально повышает производительность многострочных операций SQL.
- Кэширование информации базы данных. Коллекции хорошо подходят для кэширования статической информации, которая часто запрашивается в ходе одного сеанса (или просто многократно запрашивается в ходе выполнения одной программы) для повышения производительности поиска.

### Концепции и терминология
Следующие пояснения помогут быстрее освоить эти структуры данных.
- Элементы и индексы. Коллекция состоит из множества элементов (фрагментов
данных), причем каждый элемент находится в определенной позиции списка, то
есть обладает определенным индексом. Иногда элементы называются «строками»,
а индексы — «номерами строк».
- Тип коллекции. Каждая переменная, представляющая коллекцию в программе,
должна быть объявлена на основании заранее определенного типа коллекции.
Как упоминалось ранее, коллекции делятся на три широкие категории: ассоциативные массивы, вложенные таблицы и VARRAY. В этих категориях существуют
конкретные типы, которые определяются командой TYPE в разделе объявлений
блока. Далее программист объявляет и использует экземпляры этих типов в своих программах.
- Коллекция, или экземпляр коллекции. Этот термин может иметь несколько значений:
  1. переменная PL/SQL типа ассоциативного массива, вложенной таблицы или VARRAY;
  2. столбец таблицы, где хранятся значения типа вложенной таблицы или массива
VARRAY.

Отчасти из-за синтаксиса и названий, которые были выбраны для поддержки коллекций Oracle, коллекции также иногда называются массивами и таблицами.

- Однородные элементы. Все элементы коллекции должны относиться к одному типу, то есть коллекция является однородной. Впрочем, этот тип данных может быть составным; например, можно объявить коллекцию, состоящую из записей, то есть таблицу. Начиная с Oracle9i, поддерживается возможность объявления многоуровневых коллекций: полем коллекции служит коллекция или запись, полем которой, в свою очередь, также является коллекция или запись и т. д.
- Одномерная коллекция. В каждой строке коллекции имеется всего одно поле, и с этой точки зрения она похожа на одномерный массив. Нельзя объявить коллекцию, на элементы которой можно было бы ссылаться следующим образом:
```
my_collection (10, 44)
```
Двумерные структуры в настоящее время напрямую не поддерживаются, однако вы
можете создать многомерный массив, объявляя коллекцию коллекцией, — синтаксис
будет примерно таким:
```
my_collection (44) (10)
```
- Ограниченная и неограниченная коллекция. Коллекция называется ограниченной, если заранее определены границы возможных значений индексов (номеров) ее элементов. Если же верхняя или нижняя граница номеров элементов не указана, то коллекция называется неограниченной. Коллекции типа VARRAY (массивы переменной длины) всегда ограничены. При определении такой коллекции следует
указать максимальное количество ее элементов (номер первого элемента всегда равен 1). Вложенные таблицы и ассоциативные массивы ограничиваются только теоретически. В тексте они будут описываться как неограниченные, потому что с теоретической точки зрения максимальное количество элементов в них может быть произвольным.
- Разреженные и плотные коллекции. Коллекция (или массив, или список) называется плотной, если все ее элементы, от первого до последнего, определены и каждому из них присвоено некоторое значение (таковым может быть и NULL).
Коллекция считается разреженной, если отдельные ее элементы отсутствуют, как в рассмотренном выше примере. Не обязательно определять все элементы коллекции и заполнять ее полностью. Массивы VARRAY всегда являются плотными. Вложенные
таблицы первоначально всегда плотные, но по мере удаления некоторых элементов становятся разреженными. Ассоциативные массивы могут быть как разреженными, так и плотными в зависимости от способа их заполнения.

Разреженность — это очень ценное свойство, позволяющее добавлять элементы в коллекцию по первичному ключу или другим ключевым данным (например, номерузаписи). Таким образом можно задать определенный порядок следования данных в коллекции или значительно ускорить их поиск.
- Целочисленное индексирование. К любому элементу коллекции можно обратиться по номеру, который представляет собой целочисленное значение. Объявление ассоциативного массива явно выражает это требование условием INDEX BY, но правило действует и для других типов коллекций.
- Строковое индексирование. Начиная с Oracle9i Release 2, в качестве индексов ассоциативных массивов можно использовать не только номера, но и символьные строки (в настоящее время до 32 Кбайт длиной). Эта возможность не поддерживается ни для вложенных таблиц, ни для массивов VARRAY.
- Внешняя таблица. Так называют таблицу, содержащую столбец типа вложенной таблицы или массива VARRAY.
- Внутренняя таблица. Так принято называть коллекцию, содержащуюся в столбце
таблицы.

###Разновидности коллекций
Как упоминалось ранее, Oracle поддерживает три разновидности коллекций. Несмотря на ряд общих характеристик, все эти разновидности обладают специфическими особенностями, которые будут охарактеризованы ниже.
- ***Ассоциативные массивы***. Это одномерные неограниченные разреженные коллекции, состоящие из однородных элементов, доступные только в PL/SQL. Ранее в PL/SQL 2 (из поставки Oracle7) они назывались таблицами PL/SQL, а в Oracle8
и Oracle8i — индексируемыми таблицами (поскольку при объявлении такой коллекции приходилось явно указывать, что она «индексируется» номером строки). В Oracle9i Release 1 они были названы ассоциативными массивами. Этот термин
выбран потому, что предложение INDEX BY может использоваться для индексирования содержимого коллекций посредством значений типа VARCHAR2 или PLS_INTEGER.
- ***Вложенные таблицы***. Так называются одномерные несвязанные коллекции, также состоящие из однородных элементов. Первоначально они заполняются полностью, но позднее из-за удаления некоторых элементов могут стать разреженными. Вложенные таблицы могут определяться и в PL/SQL, и в базах данных (например,в качестве столбцов таблиц). Вложенные таблицы представляют собой мультимножества, то есть элементы вложенной таблицы не упорядочены.
- ***Массив типа VARRAY***. Подобно двум другим типам коллекций, массивы VARRAY (массивы переменной длины) также являются одномерными коллекциями, состоящими из однородных элементов. Однако их размер всегда ограничен, и они не бывают разреженными. Как и вложенные таблицы, массивы VARRAY используются и в PL/SQL, и в базах данных. Однако порядок их элементов при сохранении и выборке, в отличие от вложенных таблиц, сохраняется.
